(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8927],{6986:(e,t,n)=>{"use strict";n.d(t,{Z:()=>m});var i=n(959),a=n(3268),o=n(715),r=n(7114),l=n(9037);const s={container:"container_KHaM",panel:"panel_p8cl",editor:"editor_LjJP",response:"response_Ger1",tool:"tool_nUFu",notool:"notool_i7V8"},c=e=>{e.getWrapperElement().closest(".graphiql-editor").style.height=`${e.doc.height}px`};function d(e){const{queryEditor:t,variableEditor:n,headerEditor:a}=(0,l._i)({nonNull:!0}),[o,r]=(0,i.useState)(e.defaultTab),d=(0,l.Xd)({onCopyQuery:e.onCopyQuery}),u=(0,l.fE)();return(0,i.useEffect)((()=>{n&&c(n)}),[o,n]),(0,i.useEffect)((()=>{a&&c(a)}),[o,a]),(0,i.useEffect)((()=>{t&&(t.setOption("lineNumbers",!1),t.setOption("gutters",[]),t.on("change",c),c(t))}),[t]),(0,i.useEffect)((()=>{n&&(n.setOption("lineNumbers",!1),n.setOption("gutters",[]),n.on("change",c))}),[n]),(0,i.useEffect)((()=>{a&&(a.setOption("lineNumbers",!1),a.setOption("gutters",[]),a.on("change",c))}),[a]),i.createElement("div",{className:"graphiql-editors"},i.createElement("section",{className:"graphiql-query-editor","aria-label":"Query Editor"},i.createElement("div",{className:"graphiql-query-editor-wrapper"},i.createElement(l.WK,{editorTheme:e.editorTheme,keyMap:e.keyMap,onCopyQuery:e.onCopyQuery,onEdit:e.onEditQuery,readOnly:e.readOnly})),i.createElement("div",{className:"graphiql-toolbar",role:"toolbar","aria-label":"Editor Commands"},i.createElement(l._8,null),i.createElement(l.wC,{onClick:()=>u(),label:"Prettify query (Shift-Ctrl-P)"},i.createElement(l.Kt,{className:"graphiql-toolbar-icon","aria-hidden":"true"})),i.createElement(l.wC,{onClick:()=>d(),label:"Copy query (Shift-Ctrl-C)"},i.createElement(l.TI,{className:"graphiql-toolbar-icon","aria-hidden":"true"})))),i.createElement("div",{className:"graphiql-editor-tools"},i.createElement("div",{className:"graphiql-editor-tools-tabs"},i.createElement(l.v0,{type:"button",className:"variables"===o?"active":"",onClick:()=>{r("variables"===o?"":"variables")}},"Variables"),i.createElement(l.v0,{type:"button",className:"headers"===o?"active":"",onClick:()=>{r("headers"===o?"":"headers")}},"Headers"))),i.createElement("section",{className:`graphiql-editor-tool ${o&&o.length>0?s.tool:s.notool}`,"aria-label":"variables"===o?"Variables":"Headers"},i.createElement(l.hF,{editorTheme:e.editorTheme,isHidden:"variables"!==o,keyMap:e.keyMap,onEdit:e.onEditVariables,readOnly:e.readOnly}),i.createElement(l.LA,{editorTheme:e.editorTheme,isHidden:"headers"!==o,keyMap:e.keyMap,onEdit:e.onEditHeaders,readOnly:e.readOnly})))}class u{constructor(){this.map=new Map,this.length=0}getItem(e){return this.map.get(e)}setItem(e,t){this.map.has(e)||(this.length+=1),this.map.set(e,t)}removeItem(e){this.map.has(e)&&(this.length-=1),this.map.delete(e)}clear(){this.length=0,this.map.clear()}}function p(){return(0,l.JB)({nonNull:!0}).isFetching?i.createElement(l.$j,null):null}function m(e){let{typegraph:t,query:n,panel:c=null,headers:m={},variables:h={},tab:f=""}=e;const{siteConfig:{customFields:{tgUrl:y}}}=(0,r.Z)(),v=(0,i.useMemo)((()=>new u),[]);return i.createElement(o.Z,{fallback:i.createElement("div",null,"Loading...")},(()=>{const e=(0,i.useMemo)((()=>(0,a.nq)({url:`${y}/${t}`})),[]);return i.createElement(l.j$,{fetcher:e,defaultQuery:n.loc.source.body.trim(),defaultHeaders:JSON.stringify(m),variables:JSON.stringify(h),storage:v},i.createElement("div",{className:`graphiql-container ${s.container}`},c?i.createElement("div",{className:`graphiql-response ${s.panel}`},c):null,i.createElement("div",{className:`graphiql-session ${s.editor}`},i.createElement(d,{defaultTab:f})),i.createElement("div",{className:`graphiql-response ${s.response}`},i.createElement(p,null),i.createElement(l.iB,null))))}))}},9688:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var i=n(1163),a=n(6986),o=n(9107),r=n(959);function l(e){let{python:t,...n}=e;return r.createElement(a.Z,(0,i.Z)({panel:r.createElement(o.Z,{language:"python"},t)},n))}},3118:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var i=n(1163),a=(n(959),n(7942)),o=(n(9107),n(9688));const r={sidebar_position:6},l="Policies and materializers",s={unversionedId:"tutorials/policies-and-materializers/index",id:"tutorials/policies-and-materializers/index",title:"Policies and materializers",description:"This section also makes use of toy typegraph for the sake of clarity. You will continue the chat-based app on the next one.",source:"@site/docs/tutorials/policies-and-materializers/index.mdx",sourceDirName:"tutorials/policies-and-materializers",slug:"/tutorials/policies-and-materializers/",permalink:"/docs/tutorials/policies-and-materializers/",draft:!1,editUrl:"https://github.com/metatypedev/metatype/tree/main/website/docs/tutorials/policies-and-materializers/index.mdx",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"docs",previous:{title:"Authentication and security",permalink:"/docs/tutorials/authentication-and-security/"},next:{title:"Your chat app",permalink:"/docs/tutorials/your-chat-app/"}},c={},d=[{value:"Deno runtime",id:"deno-runtime",level:2},{value:"Policy based access control (PBAC)",id:"policy-based-access-control-pbac",level:2}],u={toc:d},p="wrapper";function m(e){let{components:t,...r}=e;return(0,a.kt)(p,(0,i.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"policies-and-materializers"},"Policies and materializers"),(0,a.kt)("p",null,"This section also makes use of toy typegraph for the sake of clarity. You will continue the chat-based app on the next one."),(0,a.kt)("h2",{id:"deno-runtime"},"Deno runtime"),(0,a.kt)("p",null,"While the tutorial covered already interesting runtimes, allowing you to connect to already a lots of systems and different protocols, there is still one powerful that wasn't covered yet: the typescript or Deno runtime."),(0,a.kt)("p",null,"This enable to run lightweight and short-lived typescript function in a sandboxed environment. Permissions can be customized per typegraph and by default only include some HTTPs domains. It's a great way to implement custom logic and materializers. All typegraphs can lazily spawn a web worker and get an incredible cold-start and continuous performance thanks to the V8 engine powering Deno."),(0,a.kt)(o.Z,{typegraph:"deno",python:n(2643),query:n(968),mdxType:"TGExample"}),(0,a.kt)("h2",{id:"policy-based-access-control-pbac"},"Policy based access control (PBAC)"),(0,a.kt)("p",null,"The Deno runtime enable to understand the last abstraction. Policies are a way to verify for each type whether the user is authorized or not to access it. It's a very powerful concept that can be for instance used to guarantee a given type is never accidentally exposed to the outside world."),(0,a.kt)("p",null,"Metatype comes with some built-in policies but you can use the Deno runtime to define your own:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"policies.public()")," is an alias for ",(0,a.kt)("inlineCode",{parentName:"li"},'Policy(PureFunMat("() => true"))')," providing everyone open access."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},'policies.jwt("role_value", "role_field")')," is a companion policy for the authentication strategy you learnt in the previous section. It will verify the context and give adequate access to the user.")),(0,a.kt)("p",null,"Policies are hierarchical in the sense that the request starts with a deny, and the root materializers must explicitly provide an access or not. Once access granted, any further types can either inherit or override the access. Policies evaluate in order in case multiple ones are defined."),(0,a.kt)(o.Z,{typegraph:"policies",python:n(7989),query:n(3971),mdxType:"TGExample"}),(0,a.kt)("p",null,"Enough studied, lets go back to your app and finalize it."))}m.isMDXComponent=!0},968:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"compute_fib"},arguments:[{kind:"Argument",name:{kind:"Name",value:"n"},value:{kind:"IntValue",value:"3"}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"res"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"ms"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:51}};t.loc.source={body:"query {\n  compute_fib(n: 3) {\n    res\n    ms\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function n(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){n(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){n(e,t)})),e.definitions&&e.definitions.forEach((function(e){n(e,t)}))}var i={};t.definitions.forEach((function(e){if(e.name){var t=new Set;n(e,t),i[e.name.value]=t}})),e.exports=t},3971:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"A"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"public"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"B"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"admin_only"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"C"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"user_only"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"D"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"both"},arguments:[],directives:[]}]}}],loc:{start:0,end:92}};t.loc.source={body:"query A {\n  public\n}\n\nquery B {\n  admin_only\n}\n\nquery C {\n  user_only\n}\n\nquery D {\n  both\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function n(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){n(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){n(e,t)})),e.definitions&&e.definitions.forEach((function(e){n(e,t)}))}var i={};function a(e,t){for(var n=0;n<e.definitions.length;n++){var i=e.definitions[n];if(i.name&&i.name.value==t)return i}}function o(e,t){var n={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(n.loc=e.loc);var o=i[t]||new Set,r=new Set,l=new Set;for(o.forEach((function(e){l.add(e)}));l.size>0;){var s=l;l=new Set,s.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){l.add(e)})))}))}return r.forEach((function(t){var i=a(e,t);i&&n.definitions.push(i)})),n}t.definitions.forEach((function(e){if(e.name){var t=new Set;n(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.A=o(t,"A"),e.exports.B=o(t,"B"),e.exports.C=o(t,"C"),e.exports.D=o(t,"D")},2643:e=>{e.exports='with TypeGraph(\n  "deno",\n) as g:\n  public = policies.public()\n\n  fib = t.func(\n    t.struct({"n": t.number()}),\n    t.struct({"res": t.integer(), "ms": t.float()}),\n    PureFunMat(\n      """\n      ({ n }) => {\n        let a = 0, b = 1, c;\n        const start = performance.now();\n        for (\n          let i = 0;\n          i < Math.min(n, 10);\n          c = a + b, a = b, b = c, i += 1\n        );\n        return {\n          res: b,\n          ms: performance.now() - start,\n        };\n      }\n      """\n    ),\n  )\n\n  g.expose(\n    compute_fib=fib,\n    default_policy=[public],\n  )'},7989:e=>{e.exports='with TypeGraph(\n  "policies",\n  auths=[\n    TypeGraph.Auth.basic(["admin", "user"]),\n  ],\n  cors=TypeGraph.Cors(\n    allow_origin=["https://metatype.dev", "http://localhost:3000"],\n    allow_headers=["authorization"],\n  ),\n) as g:\n  random = RandomRuntime()\n  public = policies.public()\n\n  admin_only = Policy(\n    PureFunMat(\n      "(args, { context }) => context.user ? context.user === \'admin\' : null"\n    ),\n  )\n  user_only = Policy(\n    PureFunMat(\n      "(args, { context }) => context.user ? context.user === \'user\' : null"\n    ),\n  )\n\n  g.expose(\n    public=random.generate(t.string()).add_policy(public),\n    admin_only=random.generate(t.string()).add_policy(admin_only),\n    user_only=random.generate(t.string()).add_policy(user_only),\n    both=random.generate(t.string()).add_policy(user_only, admin_only),\n  )'}}]);