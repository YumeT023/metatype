meta:
    workdir: .
    watches:
        - "meta-cli/src/**/*.rs"
        - "typegraph/**/*.py"
    shell: "cargo run -p meta -- -C examples dev -p password"
    envs:
        VIRTUAL_ENV: $PWD/examples/.venv
        PATH: $PWD/examples/.venv/bin:$PATH
    depends_on:
        - libs
        - typegate_native

system_graphs:
    workdir: typegate
    watches: src/typegraphs/*.py
    shell: "./serialize-tgs.sh"
    depends_on:
        - meta

typegate1:
    workdir: typegate
    watches: "src/**/*.ts"
    envs:
        TG_PORT: "7891"
        PACKAGED: "false"
    shell: "./run.sh"
    depends_on:
        - clean_deno_bindgen_cache

typegate2:
    workdir: typegate
    watches: "src/**/*.ts"
    envs:
        TG_PORT: "7892"
        PACKAGED: "false"
    shell: "./run.sh"
    depends_on:
        - clean_deno_bindgen_cache

libs:
    workdir: libs
    watches: "**/*.rs"
    shell: "cargo build -p common"

clean_deno_bindgen_cache:
    shell: rm -rf $(deno info --json | jq -r .denoDir)/plug/file
    depends_on:
        - typegate_native

typegate_native:
    watches:
        - "typegate/native/src/**/*.rs"
    shell: "deno_bindgen -- -p native"
    depends_on:
        - libs

website:
    workdir: website
    shell: "pnpm start --no-open"
